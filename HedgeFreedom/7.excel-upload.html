<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7. 엑셀업로드</title>
    <style>
        body { font-family: "Malgun Gothic", "맑은 고딕", Dotum, "돋움", sans-serif; background: #eef1f6; color: #333; margin: 0; }
        .header { background: #fff; border-bottom: 2px solid #4a90e2; height: 45px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; }
        .logo { font-size: 14px; font-weight: bold; color: #4a90e2; padding: 0 10px; border-right: 1px solid #ddd; flex: 0 0 auto; }
        #fx-rate-header { flex: 1 1 auto; text-align: right; }
        .system-name { font-size: 13px; color: #333; font-weight: 600; }
        .menu-bar { background: #fff; border-bottom: 1px solid #ddd; height: 35px; display: flex; align-items: center; padding: 0 10px; }
        .menu-item { padding: 8px 15px; min-width: 90px; text-align: center; color: #555; cursor: pointer; font-size: 12px; border-right: 1px solid #e5e5e5; background: #fafafa; text-decoration: none; display: inline-block; box-sizing: border-box; }
        .menu-item:last-child { border-right: none; }
        .menu-item.active { background: #4a90e2; color: #fff; font-weight: bold; }
        .workspace { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .page-title { background: #fff; padding: 10px 15px; margin-bottom: 18px; border: 1px solid #ddd; font-size: 15px; font-weight: bold; color: #333; display: flex; justify-content: space-between; align-items: center; }
        .breadcrumb { font-size: 11px; color: #999; font-weight: normal; }
    </style>
</head>
<body>
    <!-- Ensure header consistency with 2.trade-input.html -->
    <div class="header">
        <div class="logo">HEDGEFREEDOM</div>
        <div id="fx-rate-header" style="font-size:13px; color:#1976d2; margin-left:auto; display:flex; gap:18px; align-items:center;">
            <span><b>USD/KRW</b> 1,325.50 <span style="color:#d32f2f;">+2.10</span> <span style="font-size:11px; color:#888;">(+0.16%)</span></span>
            <span><b>EUR/KRW</b> 1,420.80 <span style="color:#1976d2;">-1.50</span> <span style="font-size:11px; color:#888;">(-0.11%)</span></span>
            <span><b>JPY/KRW</b> 9.85 <span style="color:#d32f2f;">+0.02</span> <span style="font-size:11px; color:#888;">(+0.20%)</span></span>
            <span style="border-left:1px solid #e0e0e0; padding-left:14px; color:#333;">
                <b>달러인덱스(DXY)</b> 104.25 <span style="color:#1976d2;">+0.12</span> <span style="font-size:11px; color:#888;">(+0.11%)</span>
            </span>
        </div>
    </div>
    <div class="menu-bar">
        <a href="1.dashboard.html" class="menu-item">대시보드</a>
        <a href="2.trade-input.html" class="menu-item">거래관리</a>
        <a href="3.internal-hedge.html" class="menu-item">내부헤지</a>
        <a href="4.hedge-strategy.html" class="menu-item">외부헤지</a>
        <a href="5.profit-analysis.html" class="menu-item">손익분석</a>
        <a href="6.report.html" class="menu-item">리포트</a>
        <a href="7.excel-upload.html" class="menu-item active">엑셀업로드</a>
    </div>
    <div class="workspace">
        <h2>ERP 집계 엑셀 업로드</h2>
        <div class="upload-box">
            <input type="file" class="file-input" id="excelFile" accept=".xlsx,.xls,.csv">
            <div>ERP(더존 등)에서 추출한 집계표를 업로드하세요.</div>
        </div>
        <div id="kpi"></div>
        <div id="output"></div>
        <div id="summary"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                const data = evt.target.result;
                const workbook = XLSX.read(data, {type: 'binary'});
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet, {header:1});
                renderTable(json);
                processMatching(json);
                    .header { background: #fff; border-bottom: 1px solid #e5e5e5; height: 60px; display: flex; align-items: center; padding: 0 32px; }
                    .logo { font-size: 22px; font-weight: bold; color: #1a237e; margin-right: 16px; }
                    #fx-rate-header { flex: 0 0 auto; font-size: 16px; color: #388e3c; min-width: 160px; margin-right: 24px; }

        function renderTable(data) {
            if (!data || data.length < 2) {
                document.getElementById('output').innerHTML = '<div style="color:#d32f2f;">엑셀 데이터가 올바르지 않습니다.</div>';
                return;
            }
            let html = '<table class="result-table"><thead><tr>';
            data[0].forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';
            for (let i=1; i<data.length; i++) {
                html += '<tr>';
                data[i].forEach(cell => html += `<td>${cell ?? ''}</td>`);
                html += '</tr>';
                    <div id="fx-rate-header" style="font-size:16px; color:#388e3c; margin-right:24px;">
                        환율: 1,350.00
                    </div>
            if (!data || data.length < 2) {
                document.getElementById('summary').innerHTML = '';
                document.getElementById('kpi').innerHTML = '';
                return;
            }
            // 헤더 인덱스 추출
            const header = data[0];
            const idx = {
                direction: header.findIndex(h => h.includes('수출') || h.includes('direction')),
                amount: header.findIndex(h => h.includes('금액') || h.toLowerCase().includes('amount')),
                maturity: header.findIndex(h => h.includes('만기') || h.toLowerCase().includes('expected'))
            };
            if (idx.direction < 0 || idx.amount < 0 || idx.maturity < 0) {
                document.getElementById('summary').innerHTML = '<div style="color:#d32f2f;">수출/수입, 금액, 만기일 컬럼이 필요합니다.</div>';
                document.getElementById('kpi').innerHTML = '';
                return;
            }
            // 데이터 파싱
            const trades = [];
            for (let i=1; i<data.length; i++) {
                const row = data[i];
                if (!row[idx.direction] || !row[idx.amount] || !row[idx.maturity]) continue;
                trades.push({
                    direction: row[idx.direction].toString().includes('수출') || row[idx.direction].toString().toLowerCase().includes('receive') ? '수출' : '수입',
                    amount: Number(row[idx.amount]),
                    maturity: row[idx.maturity].toString().slice(0,10)
                });
            }
            // 기간별 집계 (월간/주간/일간)
            const byPeriod = { 월간: {}, 주간: {}, 일간: {} };
            trades.forEach(tr => {
                const date = new Date(tr.maturity);
                if (isNaN(date)) return;
                const ym = date.getFullYear() + '-' + String(date.getMonth()+1).padStart(2,'0');
                const yw = date.getFullYear() + '-W' + getWeekNumber(date);
                const yd = date.toISOString().slice(0,10);
                [ ['월간',ym], ['주간',yw], ['일간',yd] ].forEach(([type,key]) => {
                    if (!byPeriod[type][key]) byPeriod[type][key] = {수출:0,수입:0};
                    byPeriod[type][key][tr.direction] += tr.amount;
                });
            });
            // KPI 계산 (전체 합계)
            let totalExport = 0, totalImport = 0, totalNetting = 0;
            Object.values(byPeriod['월간']).forEach(val => {
                totalExport += val.수출;
                totalImport += val.수입;
                totalNetting += Math.min(val.수출, val.수입);
            });
            // KPI 카드 표시
            let kpiHtml = '<div class="kpi-row">';
            kpiHtml += `<div class="kpi-card"><div class="kpi-label">총 수출 합계</div><div class="kpi-value">${totalExport.toLocaleString()}</div></div>`;
            kpiHtml += `<div class="kpi-card"><div class="kpi-label">총 수입 합계</div><div class="kpi-value">${totalImport.toLocaleString()}</div></div>`;
            kpiHtml += `<div class="kpi-card"><div class="kpi-label">내부 상계(네팅) 가능</div><div class="kpi-value kpi-main">${totalNetting.toLocaleString()}</div></div>`;
            kpiHtml += '</div>';
            document.getElementById('kpi').innerHTML = kpiHtml;
            // 요약 HTML 생성
            let html = '<div class="summary"><b>만기일 기준 집계</b><br><br>';
            ['월간','주간','일간'].forEach(type => {
                html += `<b>${type}</b><table class="result-table"><thead><tr><th>기간</th><th>수출 합계</th><th>수입 합계</th><th>내부 상계(최소값)</th></tr></thead><tbody>`;
                Object.entries(byPeriod[type]).sort().forEach(([key,val]) => {
                    html += `<tr><td>${key}</td><td>${val.수출.toLocaleString()}</td><td>${val.수입.toLocaleString()}</td><td style="color:#1976d2;font-weight:bold;">${Math.min(val.수출,val.수입).toLocaleString()}</td></tr>`;
                });
                html += '</tbody></table><br>';
            });
            html += '<div style="color:#1976d2; margin-top:10px;">내부 상계(네팅) 가능한 금액 = 수출/수입 중 작은 값</div></div>';
            document.getElementById('summary').innerHTML = html;
        }
        // 주차 구하기
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            const yearStart = new Date(Date.UTC(d.getFullYear(),0,1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + yearStart.getUTCDay()+1)/7);
            return String(weekNo).padStart(2,'0');
        }
    </script>
</body>
</html>
