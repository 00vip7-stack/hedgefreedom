<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>거래관리</title>
    <style>
        body { font-family: "Malgun Gothic", "맑은 고딕", Dotum, "돋움", sans-serif; background: #eef1f6; color: #333; margin: 0; }
        .header { background: #fff; border-bottom: 2px solid #4a90e2; height: 45px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; }
        .logo { font-size: 14px; font-weight: bold; color: #4a90e2; padding: 0 10px; border-right: 1px solid #ddd; }
        .system-name { font-size: 13px; color: #333; font-weight: 600; }
        .menu-bar { background: #fff; border-bottom: 1px solid #ddd; height: 35px; display: flex; align-items: center; padding: 0 10px; }
        .menu-item { padding: 8px 15px; color: #555; cursor: pointer; font-size: 12px; border-right: 1px solid #e5e5e5; background: #fafafa; text-decoration: none; display: inline-block; }
        .menu-item.active { background: #4a90e2; color: #fff; font-weight: bold; }
        .workspace { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .page-title { background: #fff; padding: 10px 15px; margin-bottom: 18px; border: 1px solid #ddd; font-size: 15px; font-weight: bold; color: #333; display: flex; justify-content: space-between; align-items: center; }
        .breadcrumb { font-size: 11px; color: #999; font-weight: normal; }
        .panel { background: #fff; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 18px; }
        .panel-header { background: linear-gradient(to bottom, #f5f7fa 0%, #e8edf2 100%); padding: 10px 18px; border-bottom: 1px solid #ddd; font-size: 13px; font-weight: bold; color: #333; }
        .panel-body { padding: 18px; }
        .trade-form { max-width: 480px; margin: 0 auto; }
        .form-group { margin-bottom: 15px; display: flex; align-items: center; }
        .form-label { width: 120px; background: #f8f8f8; border: 1px solid #d5d5d5; padding: 6px 10px; font-size: 12px; font-weight: bold; color: #333; }
        .form-input { flex: 1; border: 1px solid #d5d5d5; padding: 6px 10px; font-size: 12px; }
        .form-input:focus { outline: none; border-color: #4a90e2; }
        .form-input:disabled { background: #f5f5f5; color: #999; }
        .form-actions { text-align: right; margin-top: 18px; }
        .form-btn { width: 120px; background: #4a90e2; color: #fff; border: none; cursor: pointer; padding: 8px 0; font-size: 13px; border-radius: 2px; }
        .trade-list-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 24px; }
        .trade-list-table th, .trade-list-table td { border: 1px solid #e0e0e0; padding: 7px 10px; text-align: center; }
        .trade-list-table th { background: #e8edf2; font-weight: bold; }
    </style>
</head>
<body>
    <div style="font-size:22px; font-weight:bold; color:#1976d2; margin-bottom:8px; letter-spacing:1px;">거래관리 모듈</div>
    <div class="menu-bar" style="margin-bottom:18px;">
        <a href="dashboard.html" class="menu-item">대시보드</a>
        <a href="trade-input.html" class="menu-item active">거래관리</a>
        <a href="hedge-strategy.html" class="menu-item">헤지전략</a>
        <a href="internal-hedge.html" class="menu-item">내부헤지</a>
        <a href="report.html" class="menu-item">리포트</a>
        <a href="index.html" class="menu-item">메인메뉴</a>
    </div>
    <div class="panel">
        <div class="panel-header">거래관리 모듈 - ERP 엑셀 자동 연동 및 거래 테이블</div>
        <div class="panel-body">
            <div id="analysis-result" style="background:#e3f2fd; color:#1976d2; font-weight:bold; border-radius:7px; padding:13px 18px; margin-bottom:18px; display:none;"></div>
            <div id="dropzone" style="border:2px dashed #4a90e2; background:#f5f7fa; padding:30px; text-align:center; margin-bottom:18px; cursor:pointer;">
                <span style="font-size:15px; color:#1976d2;">여기로 엑셀 파일을 드래그하거나 클릭하여 업로드하세요</span>
                <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" style="display:none;">
            </div>
            <div id="output">
                <table class="trade-list-table" id="tradeListTable">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>거래번호</th>
                            <th>거래일자</th>
                            <th>통화</th>
                            <th>거래금액</th>
                            <th>만기일</th>
                            <th>헤지상태</th>
                        </tr>
                    </thead>
                    <tbody id="excel-tbody">
                        <tr><td colspan="7" style="color:#999;">엑셀 업로드 시 자동 집계</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        // 거래 데이터 테이블 렌더링 함수 (모듈화)
        function renderTradeTable(data) {
            var tbody = document.getElementById('excel-tbody');
            var analysisDiv = document.getElementById('analysis-result');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="color:#999;">거래 데이터가 없습니다.</td></tr>';
                analysisDiv.style.display = 'none';
                return;
            }
            tbody.innerHTML = data.map(function(row, idx) {
                return `<tr>` +
                    `<td>${idx+1}</td>` +
                    `<td>${row.tradeId ?? ''}</td>` +
                    `<td>${row.tradeDate ?? ''}</td>` +
                    `<td>${row.currency ?? ''}</td>` +
                    `<td>${row.amount ?? ''}</td>` +
                    `<td>${row.maturity ?? ''}</td>` +
                    `<td>${row.hedgeStatus ?? ''}</td>` +
                `</tr>`;
            }).join('');

            // --- 자동 분석 및 매칭 결과 표시 ---
            // (실제 로직은 백엔드/실데이터에 맞게 교체)
            var total = data.length;
            // 예시: '완료' 상태가 자동 상계된 건으로 가정
            var matched = data.filter(function(row){ return row.hedgeStatus === '완료'; }).length;
            // 예시: 남은 금액(진행중만 합산)
            var remainAmount = data.filter(function(row){ return row.hedgeStatus !== '완료'; })
                .reduce(function(sum, row){ return sum + (parseFloat(row.amount)||0); }, 0);
            var remainAmountStr = remainAmount.toLocaleString();
            analysisDiv.innerText = `업로드 완료! ${total}건의 거래 중 ${matched}건이 자동으로 상계(매칭)되었습니다. 남은 $${remainAmountStr}만 외부 헤지하시면 됩니다.`;
            analysisDiv.style.display = 'block';
        }

        // 임시 더미 API 호출 함수 (모듈화)
        function fetchTradeData() {
            // 실제 API로 교체 시 이 부분만 수정
            return new Promise(function(resolve) {
                setTimeout(function() {
                    resolve([
                        {tradeId:'T20260101', tradeDate:'2026-01-01', currency:'USD', amount:10000, maturity:'2026-03-01', hedgeStatus:'진행중'},
                        {tradeId:'T20260115', tradeDate:'2026-01-15', currency:'EUR', amount:8000, maturity:'2026-04-01', hedgeStatus:'완료'},
                        {tradeId:'T20260120', tradeDate:'2026-01-20', currency:'JPY', amount:1200000, maturity:'2026-05-01', hedgeStatus:'진행중'}
                    ]);
                }, 500);
            });
        }

        // 페이지 진입 시 자동으로 거래 데이터 불러오기
        window.addEventListener('DOMContentLoaded', function() {
            fetchTradeData().then(renderTradeTable);
        });

        // (엑셀 업로드 기능은 주석처리, 필요시 복구 가능)
        /*
        // 드래그&드롭 및 클릭 업로드 지원
        document.addEventListener('DOMContentLoaded', function() {
            var dropzone = document.getElementById('dropzone');
            var fileInput = document.getElementById('excelFile');
            dropzone.addEventListener('click', function() { fileInput.click(); });
            dropzone.addEventListener('dragover', function(e) { e.preventDefault(); dropzone.style.background='#e3f2fd'; });
            dropzone.addEventListener('dragleave', function(e) { e.preventDefault(); dropzone.style.background='#f5f7fa'; });
            dropzone.addEventListener('drop', function(e) {
                e.preventDefault(); dropzone.style.background='#f5f7fa';
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    handleExcelFile(e.dataTransfer.files[0]);
                }
            });
            fileInput.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    handleExcelFile(e.target.files[0]);
                }
            });
        });
        function handleExcelFile(file) {
            var reader = new FileReader();
            reader.onload = function(evt) {
                var data = evt.target.result;
                var workbook = XLSX.read(data, {type: 'binary'});
                var sheetName = workbook.SheetNames[0];
                var sheet = workbook.Sheets[sheetName];
                var json = XLSX.utils.sheet_to_json(sheet, {header:1});
                renderExcelTable(json);
            };
            reader.readAsBinaryString(file);
        }
        function renderExcelTable(data) {
            var tbody = document.getElementById('excel-tbody');
            if (!data || data.length < 2) {
                tbody.innerHTML = '<tr><td colspan="7" style="color:#999;">엑셀 데이터가 올바르지 않습니다.</td></tr>';
                return;
            }
            tbody.innerHTML = data.slice(1).map(function(row, idx) {
                return `<tr>` + row.map(function(cell) {
                    return `<td>${cell ?? ''}</td>`;
                }).join('') + `</tr>`;
            }).join('');
        }
        */
    </script>
</body>
</html>
